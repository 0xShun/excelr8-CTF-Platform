{% extends 'ctf/base.html' %}

{% block title %}Scoreboard - EXCELR8 CTF{% endblock %}

{% block extra_css %}
<style>
    /* Layout */
    .scoreboard-header { 
        background: rgba(0, 255, 255, 0.05);
        border: 1px solid var(--accent-primary);
        border-radius: 14px;
        padding: 16px 18px;
        margin-bottom: 20px;
        box-shadow: 0 0 20px var(--accent-glow);
        display: flex; align-items: center; justify-content: space-between;
    }
    .header-actions { display: flex; gap: 10px; align-items: center; }

    /* Neon button */
    .neon-btn {
        appearance: none; border: 1px solid var(--accent-primary); color: var(--accent-primary);
        background: transparent; padding: 8px 14px; border-radius: 10px; font-weight: 700;
        letter-spacing: .04em; text-transform: uppercase; transition: box-shadow .2s, background .2s, color .2s;
        box-shadow: 0 0 12px rgba(0,255,255,.15) inset, 0 0 10px rgba(0,255,255,.15);
    }
    .neon-btn:hover { background: rgba(0,255,255,.12); color: #fff; box-shadow: 0 0 18px var(--accent-glow), 0 0 12px rgba(0,255,255,.35) inset; }
    .neon-btn:disabled { opacity: .7; cursor: not-allowed; }

    /* Panel (chart + table wrappers) */
    .panel { 
        border: 1px solid var(--accent-primary); border-radius: 14px; background: var(--bg-secondary);
        overflow: hidden; box-shadow: none; margin-bottom: 18px;
    }
    .panel-header { padding: 12px 16px; background: rgba(0,255,255,.08); color: var(--accent-primary);
        font-weight: 700; letter-spacing: .04em; display: flex; align-items: center; gap: 8px; }
    .panel-body { padding: 14px 16px; }
    .panel-footer { padding: 10px 16px; border-top: 1px solid rgba(0,255,255,.18); color: var(--text-muted); background: transparent; }

    /* Neon table (no Bootstrap) */
    table.neon-table { width: 100%; border-collapse: collapse; color: var(--text-primary); }
    .neon-table thead th {
        background: var(--accent-primary); color: var(--bg-primary); border: none; padding: 10px 12px;
        text-transform: uppercase; letter-spacing: .06em; font-weight: 800; font-size: 0.9rem;
    }
    .neon-table tbody td { padding: 12px; border-bottom: 1px solid rgba(0,255,255,.18); }
    .neon-table tbody tr { transition: background .2s ease, color .2s ease; }
    .neon-table tbody tr:hover { background: rgba(0,255,255,.08); color: #fff; }
    .center { text-align: center; }
    .muted { color: var(--text-muted); font-size: .85rem; }
    .team-score { color: var(--accent-primary); font-weight: 800; text-shadow: 0 0 5px var(--accent-glow); display: inline-block; padding: 4px 8px; border: 1px solid var(--accent-primary); border-radius: 8px; }

    /* Top 3 subtle highlight */
    .rank-1 { background: rgba(0,255,255,0.10); }
    .rank-2 { background: rgba(0,255,255,0.06); }
    .rank-3 { background: rgba(0,255,255,0.03); }
    .rank-1:hover, .rank-2:hover, .rank-3:hover { background: rgba(0,255,255,0.18); }

    /* Utility */
    .stack { display:flex; align-items:center; gap:6px; }
</style>
{% endblock %}

{% block content %}
<div class="scoreboard-header">
    <h2 class="stack"><i class="fas fa-trophy"></i> SCOREBOARD</h2>
    <div class="header-actions">
        <button id="refreshScoreboardBtn" class="neon-btn"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
    
</div>

<!-- Score progression chart -->
<div class="panel">
    <div class="panel-header"><i class="fas fa-chart-line"></i> Team Score Progression</div>
    <div class="panel-body">
        <div style="height: 260px;">
            <canvas id="scoreProgressChart"></canvas>
        </div>
    </div>
    <div class="panel-footer">Tip: Toggle teams by clicking their names in the legend.</div>
</div>

<div class="panel">
    <div class="panel-body" style="padding:0;">
        <div style="overflow-x:auto;">
            <table class="neon-table">
                <thead>
                    <tr>
                        <th class="center">#</th>
                        <th>TEAM</th>
                        <th>AFFILIATION</th>
                        <th class="center">SCORE</th>
                        <th class="center">SOLVED</th>
                        <th class="center">LAST SOLVE</th>
                    </tr>
                </thead>
                <tbody id="scoreboard-body">
                    {% for data in team_data %}
                    <tr class="{% if forloop.counter == 1 %}rank-1{% elif forloop.counter == 2 %}rank-2{% elif forloop.counter == 3 %}rank-3{% endif %}">
                        <td class="center">
                            <strong>
                                {% if forloop.counter == 1 %}
                                    <i class="fas fa-trophy" style="color: gold;"></i>
                                {% elif forloop.counter == 2 %}
                                    <i class="fas fa-medal" style="color: silver;"></i>
                                {% elif forloop.counter == 3 %}
                                    <i class="fas fa-medal" style="color: #cd7f32;"></i>
                                {% else %}
                                    {{ forloop.counter }}
                                {% endif %}
                            </strong>
                        </td>
                        <td>
                            <strong>{{ data.team.name }}</strong>
                            <div class="muted">{{ data.team.members.count }} member{{ data.team.members.count|pluralize }}</div>
                        </td>
                        <td>{{ data.team.affiliation|default:"-" }}</td>
                        <td class="center"><span class="team-score">{{ data.score }}</span></td>
                        <td class="center"><i class="fas fa-check-circle" style="color: var(--accent-primary);"></i> {{ data.solve_count }}</td>
                        <td class="center">{% if data.last_solve %}{{ data.last_solve|timesince }} ago{% else %}-{% endif %}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="center" style="padding: 24px;">
                            <div class="muted"><i class="fas fa-users fa-lg"></i></div>
                            <div>No teams registered yet</div>
                            <div class="muted">Be the first to register a team!</div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    
</div>

{% if user.is_authenticated %}
<div class="center" style="margin-top: 18px;">
    <a href="{% url 'ctf:user_stats' %}" class="neon-btn"><i class="fas fa-chart-bar"></i> View Your Stats</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
<script>
// Unified AJAX refresh: updates table and chart without reloading the page
async function refreshAll() {
    const btn = document.getElementById('refreshScoreboardBtn');
    if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing'; }
    try {
        const [tableRes, chartRes] = await Promise.all([
            fetch('{% url "ctf:scoreboard_json" %}'),
            fetch('{% url "ctf:scoreboard_timeseries_json" %}')
        ]);
        const tableJson = await tableRes.json();
        const chartJson = await chartRes.json();
        updateScoreboardTable(tableJson.teams);
        if (window._scoreChart && chartJson.series) {
            window._scoreChart.data.datasets = toDataset(chartJson.series);
            window._scoreChart.update();
        }
    } catch (e) {
        console.log('Refresh error', e);
    } finally {
        if (btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt"></i> REFRESH'; }
    }
}

// Auto-refresh every 30 seconds
setInterval(refreshAll, 30000);

function updateScoreboardTable(teams) {
    const tbody = document.getElementById('scoreboard-body');
    if (!tbody || !teams) return;
    
    let html = '';
    teams.forEach((team, index) => {
        const rank = index + 1;
        let rankIcon = rank;
        
        if (rank === 1) rankIcon = '<i class="fas fa-trophy" style="color:gold;"></i>';
        else if (rank === 2) rankIcon = '<i class="fas fa-medal" style="color:silver;"></i>';
        else if (rank === 3) rankIcon = '<i class="fas fa-medal" style="color:#cd7f32;"></i>';
        
        const rankClass = rank <=3 ? `rank-${rank}` : '';
        html += `
            <tr class="${rankClass}">
                <td class="center"><strong>${rankIcon}</strong></td>
                <td><strong>${team.name}</strong></td>
                <td>${team.affiliation || '-'}</td>
                <td class="center"><span class="team-score">${team.score}</span></td>
                <td class="center"><i class=\"fas fa-check-circle\" style=\"color: var(--accent-primary);\"></i> ${team.solved_count}</td>
                <td class="center">${team.last_solve ? timeAgo(team.last_solve) : '\u2014'}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function timeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const seconds = Math.floor((now - date) / 1000);
    
    if (seconds < 60) return seconds + ' seconds ago';
    const minutes = Math.floor(seconds / 60);
    if (minutes < 60) return minutes + ' minutes ago';
    const hours = Math.floor(minutes / 60);
    if (hours < 24) return hours + ' hours ago';
    const days = Math.floor(hours / 24);
    return days + ' days ago';
}

// Score progression chart (multiline)
document.addEventListener('DOMContentLoaded', function () {
    const ctx = document.getElementById('scoreProgressChart');
    if (!ctx || !window.Chart) return;

    const themeColors = [
        '#00FFFF', '#00D1FF', '#52FFA8', '#FFB703', '#FF6B6B', '#B388FF', '#5EEAD4', '#F472B6', '#60A5FA', '#F59E0B'
    ];

    function colorFor(idx) { return themeColors[idx % themeColors.length]; }

    function toDataset(series) {
        return series.map((s, i) => ({
            label: s.team,
            data: (s.data || []).map(p => ({ x: new Date(p.t), y: Number(p.y) || 0 })),
            borderColor: colorFor(i),
            backgroundColor: 'transparent',
            tension: 0.25,
            borderWidth: 2,
            pointRadius: 2,
            pointHoverRadius: 4,
        }));
    }

    window._scoreChart = new Chart(ctx, {
        type: 'line',
        data: { datasets: [] },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'nearest', intersect: false },
            scales: {
                x: { type: 'time', time: { unit: 'hour', tooltipFormat: 'MMM d, HH:mm' }, grid: { color: 'rgba(0,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)' } },
                y: { beginAtZero: true, grid: { color: 'rgba(0,255,255,0.1)' }, ticks: { color: 'rgba(255,255,255,0.7)' } }
            },
            plugins: {
                legend: { labels: { color: 'rgba(255,255,255,0.9)' } },
                tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y} pts` } }
            }
        }
    });

    refreshAll();
});
</script>
{% endblock %}
