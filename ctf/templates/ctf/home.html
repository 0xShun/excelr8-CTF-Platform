{% extends 'ctf/base.html' %}

{% block title %}Welcome - EXCELR8 CTF{% endblock %}

{% block extra_css %}
<style>
    .landing-hero {
        min-height: 80vh;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        background: radial-gradient(ellipse at center, rgba(0, 255, 255, 0.1) 0%, transparent 70%);
        position: relative;
        overflow: hidden;
    }
    
    .landing-hero::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            linear-gradient(45deg, transparent 49%, rgba(0, 255, 255, 0.03) 50%, transparent 51%),
            linear-gradient(-45deg, transparent 49%, rgba(0, 255, 255, 0.03) 50%, transparent 51%);
        background-size: 20px 20px;
        animation: matrix 20s linear infinite;
        pointer-events: none;
    }
    
    @keyframes matrix {
        0% { transform: translateY(0); }
        100% { transform: translateY(-20px); }
    }
    
    .landing-logo {
        max-width: 400px;
        height: auto;
        margin-bottom: 2rem;
        filter: drop-shadow(0 10px 20px var(--accent-glow));
    }
    
    .landing-title {
        font-size: 4rem;
        font-weight: 700;
        letter-spacing: 3px;
        margin-bottom: 1rem;
        color: var(--accent-primary);
        text-shadow: 0 0 30px var(--accent-glow);
        animation: glow-pulse 2s ease-in-out infinite alternate;
    }
    
    @keyframes glow-pulse {
        from { text-shadow: 0 0 20px var(--accent-glow); }
        to { text-shadow: 0 0 40px var(--accent-glow), 0 0 60px var(--accent-glow); }
    }
    
    .landing-subtitle {
        font-size: 1.2rem;
        color: var(--text-secondary);
        margin-bottom: 3rem;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        font-family: "Courier Prime", monospace;
    }
    
    .landing-buttons {
        margin-bottom: 3rem;
    }
    
    .landing-buttons .btn {
        margin: 0 1rem;
        padding: 1rem 2rem;
        font-size: 1.1rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 2px;
        position: relative;
        overflow: hidden;
    }
    
    .stats-section {
        background: rgba(33, 37, 41, 0.8);
        border: 1px solid var(--accent-primary);
        border-radius: 20px;
        padding: 2rem;
        margin-top: 4rem;
        backdrop-filter: blur(20px);
        box-shadow: 0 0 30px var(--accent-glow);
    }
    
    .stat-card {
        background: transparent;
        border: 2px solid var(--accent-primary);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, var(--accent-glow), transparent);
        transition: left 0.5s;
    }
    
    .stat-card:hover::before {
        left: 100%;
    }
    
    .stat-card:hover {
        border-color: var(--accent-primary);
        transform: translateY(-10px);
        box-shadow: 0 15px 40px var(--accent-glow);
    }
    
    .stat-number {
        font-size: 3rem;
        font-weight: 700;
        color: var(--accent-primary);
        margin-bottom: 0.5rem;
        text-shadow: 0 0 10px var(--accent-glow);
    }
    
    .stat-label {
        color: var(--text-secondary);
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: bold;
    }
    
    .countdown-section {
        margin-top: 2rem;
        padding: 2rem;
        background: rgba(0, 255, 255, 0.05);
        border-radius: 15px;
        border: 1px solid var(--accent-primary);
        box-shadow: 0 0 20px var(--accent-glow);
    }
    
    .countdown-timer {
        font-family: "Courier Prime", monospace;
        font-size: 3rem;
        font-weight: 700;
        color: var(--accent-primary);
        margin-top: 1rem;
        text-shadow: 0 0 20px var(--accent-glow);
        letter-spacing: 3px;
    }
    .countdown-labels {
        display: flex;
        justify-content: center;
        gap: 1.2rem; /* space roughly matching colon spacing */
        margin-top: 0.35rem;
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        font-weight: 600;
        color: var(--text-secondary);
        opacity: 0.8;
        pointer-events: none;
        user-select: none;
    }
    .countdown-labels span { min-width: 3ch; text-align: center; }

    /* Join Team Callout */
    .join-team-callout {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 1.25rem;
        padding: 1.1rem 1.2rem;
        border-radius: 16px;
        background: linear-gradient(180deg, rgba(0,0,0,0.35), rgba(0,0,0,0.15));
        border: 1px solid var(--accent-primary);
        box-shadow: 0 0 22px var(--accent-glow);
    }
    .join-team-callout .callout-text {
        display: flex;
        align-items: center;
        gap: 0.9rem;
        color: var(--text-primary);
    }
    .join-team-callout .callout-text i {
        color: #ffd166;
        text-shadow: 0 0 12px rgba(255, 209, 102, 0.6);
        font-size: 1.1rem;
    }
    .join-team-callout .callout-text .title {
        font-weight: 700;
        letter-spacing: 0.5px;
        margin: 0 0 4px 0;
        color: var(--accent-primary);
        text-shadow: 0 0 10px var(--accent-glow);
    }
    .join-team-callout .callout-text .subtitle {
        color: var(--text-secondary);
        font-size: 0.95rem;
        margin: 0;
        line-height: 1.35;
    }
    .join-team-callout .cta-actions {
        display: flex;
        flex-direction: column;
        align-items: stretch;
        gap: 0.6rem;
    }
    .cta-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        padding: 0.5rem 1rem;
        min-width: 180px;
        border-radius: 12px;
        border: 1px solid var(--accent-primary);
        color: var(--accent-primary);
        text-decoration: none;
        font-weight: 700;
        letter-spacing: 0.5px;
        transition: all 0.2s ease;
        box-shadow: 0 0 0 rgba(0,0,0,0);
        background: rgba(0, 255, 255, 0.08);
    }
    .cta-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 0 16px var(--accent-glow);
        background: rgba(0, 255, 255, 0.15);
    }
    .cta-btn--solid {
        background: linear-gradient(180deg, var(--accent-primary), #00d1d1);
        color: #0a0f14;
        border-color: transparent;
        text-shadow: none;
    }
    .cta-btn--solid:hover {
        box-shadow: 0 0 22px var(--accent-glow);
        filter: saturate(1.2);
    }
    @media (max-width: 575px) {
        .join-team-callout { grid-template-columns: 1fr; }
        .join-team-callout .cta-actions { flex-direction: row; }
        .cta-btn { flex: 1; min-width: 0; }
    }
</style>
{% endblock %}

{% block content %}
<div class="landing-hero">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <img src="https://i.imgur.com/B3yt85N.png" alt="EXCELR8 CTF" class="landing-logo">
                <!-- <h1 class="landing-title">CTF</h1> -->
                <p class="landing-subtitle">
                    Accelerate your cybersecurity skills. Push beyond limits. Excel in every challenge.
                </p>
                
                {% if not user.is_authenticated %}
                <div class="landing-buttons">
                    <a href="{% url 'ctf:register' %}" class="btn btn-primary">
                        <i class="fas fa-rocket"></i> Get Started
                    </a>
                    <a href="{% url 'login' %}" class="btn btn-outline-light">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </a>
                </div>
                {% endif %}
                
                <!-- Competition Status -->
                <div class="countdown-section">
                    <h4><i class="fas fa-clock"></i> Competition Status</h4>
                    <div class="countdown-timer">
                        <span id="timer"
                              data-start-ts="{{ competition_start_ts|default:'' }}"
                              data-end-ts="{{ competition_end_ts|default:'' }}">00:00:00:00</span>
                    </div>
                    <div class="countdown-labels">
                        <span>Days</span>
                        <span>Hours</span>
                        <span>Minutes</span>
                        <span>Seconds</span>
                    </div>
                    <p class="mb-0">Time Remaining</p>
                </div>
            </div>
        </div>
        
        <!-- Statistics Section -->
        <div class="stats-section">
            <div class="row">
                <div class="col-md-3 mb-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-number">{{ total_challenges }}</div>
                            <div class="stat-label">Challenges</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-number">{{ total_teams }}</div>
                            <div class="stat-label">Teams</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-number">{{ total_users }}</div>
                            <div class="stat-label">Players</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card stat-card h-100">
                        <div class="card-body text-center">
                            <div class="stat-number">{{ total_solves }}</div>
                            <div class="stat-label">Solves</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if user.is_authenticated %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-trophy"></i> Your Progress</h5>
                </div>
                <div class="card-body">
                    <p><strong>Score:</strong> <span class="badge score-badge">{{ individual_score }}</span></p>
                    <p><strong>Challenges Solved:</strong> {{ user_solved_count }}</p>
                    {% if user.userprofile.team %}
                        <p><strong>Team:</strong> {{ user.userprofile.team.name }}</p>
                        <p><strong>Team Rank:</strong> #{{ user.userprofile.team.rank }}</p>
                    {% else %}
                        <div class="join-team-callout mt-3">
                            <div class="callout-text">
                                <i class="fas fa-exclamation-triangle"></i>
                                <div>
                                    <div class="title">No Team Yet</div>
                                    <div class="subtitle">Team up to compete on the leaderboard and unlock collaborative power-ups.</div>
                                </div>
                            </div>
                            <div class="cta-actions">
                                <a class="cta-btn cta-btn--solid" href="{% url 'ctf:team_register' %}"><i class="fas fa-users"></i>&nbsp; Create Team</a>
                                <a class="cta-btn" href="{% url 'ctf:team_join' %}"><i class="fas fa-sign-in-alt"></i>&nbsp; Join Team</a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-clock"></i> Recent Activity</h5>
                </div>
                <div class="card-body">
                    {% if recent_solves %}
                        {% for solve in recent_solves %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span>
                                    <strong>{{ solve.user.username }}</strong>
                                    solved
                                    <em>{{ solve.challenge.title }}</em>
                                </span>
                                <small class="text-muted">{{ solve.timestamp|timesince }} ago</small>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted">No recent activity. <a href="{% url 'ctf:challenge_list' %}">Start solving challenges!</a></p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// Robust countdown timer (uses server-supplied epoch ms to avoid timezone parsing issues)
(function() {
    const timerEl = document.getElementById('timer');
    if (!timerEl) return;
    const rawEnd = timerEl.getAttribute('data-end-ts');
    const rawStart = timerEl.getAttribute('data-start-ts');
    const endTs = rawEnd && /^\d+$/.test(rawEnd) ? parseInt(rawEnd, 10) : null;
    const startTs = rawStart && /^\d+$/.test(rawStart) ? parseInt(rawStart, 10) : null;

    if (!endTs) {
        timerEl.textContent = 'Not Scheduled';
        return;
    }

    function format(diffMs) {
        const totalSeconds = Math.floor(diffMs / 1000);
        const days = Math.floor(totalSeconds / 86400);
        const hours = Math.floor((totalSeconds % 86400) / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return [days, hours, minutes, seconds]
            .map(n => n.toString().padStart(2, '0'))
            .join(':');
    }

    function tick() {
        const now = Date.now();
        const parent = timerEl.closest('.countdown-section');
        const status = parent ? parent.querySelector('.mb-0') : null;

        // Before start
        if (startTs && now < startTs) {
            const untilStart = startTs - now;
            timerEl.textContent = format(untilStart);
            if (status) status.textContent = 'Starts In';
            return;
        }

        if (status && status.textContent !== 'Time Remaining') {
            status.textContent = 'Time Remaining';
        }

        const diff = endTs - now;
        if (diff <= 0) {
            timerEl.textContent = '00:00:00:00';
            if (status) status.textContent = 'Competition Ended';
            clearInterval(intervalId);
            return;
        }
        timerEl.textContent = format(diff);
    }

    const intervalId = setInterval(tick, 1000);
    tick();
})();
</script>
{% endblock %}
