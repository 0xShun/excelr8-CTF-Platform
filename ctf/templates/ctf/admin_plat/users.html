{% extends 'ctf/base.html' %}
{% block title %}Admin - Users & Teams{% endblock %}

{% block extra_css %}
<style>
  .admin-users .card { overflow: hidden; }
  .admin-users .card-header { display: flex; align-items: center; justify-content: space-between; }
  .admin-users .searchbox {
    display: flex; gap: .5rem; align-items: center;
    background: rgba(0,0,0,.25); border: 1px solid var(--accent-primary);
    padding: .35rem .6rem; border-radius: 10px;
    box-shadow: 0 0 12px var(--accent-glow) inset;
  }
  .admin-users .searchbox input {
    background: transparent; border: none; outline: none; color: var(--text-primary);
    width: 220px;
  }
  .neon-table { border-collapse: separate; border-spacing: 0 10px; }
  .neon-table thead th { position: sticky; top: 0; background: rgba(0,255,255,.08); }
  .neon-table tbody tr { background: rgba(0,0,0,.25); border: 1px solid var(--accent-primary); }
  .neon-table tbody tr:hover { box-shadow: 0 0 18px var(--accent-glow); }
  .neon-table tbody td { border-top: 1px solid rgba(0,255,255,.25); }
  .pill { display: inline-block; padding: .2rem .5rem; border-radius: 999px; font-weight: 800; font-size: .75rem; }
  .pill--cyan { background: var(--accent-primary); color: #061018; box-shadow: 0 0 8px var(--accent-glow); }
  .mono { font-family: "Courier Prime", monospace; }
  .small { font-size: .85rem; opacity: .9; }
  .btn-actions { display: inline-flex; gap: .35rem; flex-wrap: wrap; justify-content: flex-end; }
  .btn-actions .btn { border-radius: 10px; padding: .25rem .55rem; }
  .list-plain .list-group-item { border: 1px solid var(--accent-primary); margin-bottom: .5rem; border-radius: 10px; }
  .metric { background: rgba(0,255,255,.08); border: 1px solid var(--accent-primary); padding: .15rem .5rem; border-radius: 8px; }
  @media (max-width: 767px) {
    .admin-users .searchbox input { width: 140px; }
  }
</style>
{% endblock %}

{% block content %}
<div class="row">
  <div class="col-md-7 mb-4 admin-users">
    <div class="card">
      <div class="card-header">
        <div><i class="fas fa-users"></i> Users</div>
        <label class="searchbox" title="Filter by username or email">
          <i class="fas fa-search"></i>
          <input id="user-filter" type="text" placeholder="Search users..." aria-label="Search users" />
        </label>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-dark align-middle neon-table" id="users-table">
            <thead><tr><th>Username</th><th>Email</th><th>Staff</th><th>Joined</th><th class="text-end">Actions</th></tr></thead>
            <tbody>
              {% for u in users %}
              <tr>
                <td class="mono"><strong>{{ u.username }}</strong></td>
                <td class="mono">{{ u.email }}</td>
                <td>{% if u.is_staff %}<span class="pill pill--cyan">STAFF</span>{% else %}-{% endif %}</td>
                <td class="mono small">{{ u.date_joined|date:'Y-m-d' }}<div class="text-muted">{{ u.date_joined|date:'H:i' }}</div></td>
                <td class="text-end">
                  <form method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="user_id" value="{{ u.id }}" />
                    <div class="btn-actions">
                      {% if u.is_staff %}
                      <button class="btn btn-sm btn-outline-light" name="action" value="demote" title="Demote from staff"><i class="fas fa-user-minus"></i> Demote</button>
                      {% else %}
                      <button class="btn btn-sm btn-primary" name="action" value="promote" title="Promote to staff"><i class="fas fa-user-shield"></i> Promote</button>
                      {% endif %}
                      {% if u.is_active %}
                      <button class="btn btn-sm btn-outline-secondary" name="action" value="deactivate" title="Deactivate user"><i class="fas fa-user-slash"></i> Deactivate</button>
                      {% else %}
                      <button class="btn btn-sm btn-primary" name="action" value="activate" title="Activate user"><i class="fas fa-user-check"></i> Activate</button>
                      {% endif %}
                      <button class="btn btn-sm btn-outline-danger btn-delete" name="action" value="delete" title="Delete user"><i class="fas fa-trash"></i> Delete</button>
                    </div>
                  </form>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-5 mb-4">
    <div class="card">
      <div class="card-header"><i class="fas fa-user-friends"></i> Teams</div>
      <div class="card-body">
        <ul class="list-group list-group-flush list-plain">
          {% for t in teams %}
          <li class="list-group-item bg-transparent text-light d-flex justify-content-between align-items-center">
            <span class="mono"><strong>{{ t.name }}</strong>
              <small class="text-muted">&nbsp;(<span class="metric">{{ t.members.count }}</span> members)</small>
            </span>
            <span class="text-muted">Score: <span class="metric mono">{{ t.total_score }}</span></span>
          </li>
          {% empty %}
          <li class="list-group-item bg-transparent text-light">No teams yet.</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const input = document.getElementById('user-filter');
  const table = document.getElementById('users-table');
  if (!input || !table) return;
  input.addEventListener('input', function(){
    const q = this.value.toLowerCase();
    const rows = table.querySelectorAll('tbody tr');
    rows.forEach(tr => {
      const username = (tr.children[0]?.textContent || '').toLowerCase();
      const email = (tr.children[1]?.textContent || '').toLowerCase();
      tr.style.display = (username.includes(q) || email.includes(q)) ? '' : 'none';
    });
  });
  table.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-delete');
    if (btn) {
      if (!confirm('Delete this user? This cannot be undone.')) {
        e.preventDefault();
      }
    }
  });
})();
</script>
{% endblock %}
